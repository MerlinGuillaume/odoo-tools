#!/usr/bin/fish

argparse 'v/version' 'p/path' 'l/list' 'r/repo' -- $argv

set root ~/src

if not string match -rq '/$'
  set root $root/
end

if set -q _flag_l
  for i in (echo (seq 12 15).0 saas-15.{1,2,3} master | string split ' ')
    echo $root$i
  end
  exit 0
end

if test (count $argv) -eq 1
  set wd (readlink --canonicalize $argv[1])
else
  set wd $PWD
end

# If not inside a directory inside root -> fail
if not string match -rq "^$root.*" $wd
  exit 1
end

set path_from_root (string replace $root '' $wd)

set parts (string split '/' $path_from_root)

set ws_version $parts[1]

if set -q _flag_v
  # ie: 14.0
  echo $ws_version
else if set -q _flag_p
  # ie: /home/odoo/src/14.0
  echo $root$ws_version
else if set -q _flag_r
  set repo $parts[2]
  if test "$repo" = odoo -o "$repo" = enterprise
    echo $repo
  else
    exit 1
  end
end
